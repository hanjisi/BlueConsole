<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>BlueConsole Pro - å®Œæ•´ç‰ˆ</title>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-panel: #1e1e1e;
            --bg-sidebar: #181818;
            --primary: #2196F3;
            --primary-hover: #1976D2;
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --border: #333333;
            --rx-green: #00E676;
            --tx-blue: #448AFF;
            --danger: #FF5252;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; outline: none; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; background: var(--bg-dark); color: var(--text-main); overflow: hidden; }

        /* --- UI æ¡†æ¶ --- */
        .app-container { display: flex; flex-direction: column; height: 100%; position: relative; z-index: 1; transition: transform 0.3s; }

        /* é¡¶éƒ¨æ  */
        .header { height: 50px; background: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px; justify-content: space-between; flex-shrink: 0; }
        .menu-btn { cursor: pointer; font-size: 22px; padding: 5px; margin-right: 10px; }
        .header-info { display: flex; flex-direction: column; }
        .profile-name { font-weight: bold; font-size: 14px; }
        .profile-hint { font-size: 10px; color: var(--primary); }
        .conn-status { font-size: 12px; color: var(--rx-green); display: flex; align-items: center; gap: 5px; }

        /* æ—¥å¿—åŒº */
        .log-area { flex: 1; background: #000; padding: 10px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 13px; min-height: 100px; }
        .log-row { margin-bottom: 2px; line-height: 1.4; word-break: break-all; }
        .ts { color: #666; margin-right: 6px; }
        .rx { color: var(--rx-green); }
        .tx { color: var(--tx-blue); }

        /* åˆ†å‰²æ¡ */
        .splitter { height: 10px; background: #262626; border-top: 1px solid #333; border-bottom: 1px solid #333; cursor: row-resize; flex-shrink: 0; display: flex; justify-content: center; align-items: center; }
        .splitter-handle { width: 40px; height: 4px; background: #444; border-radius: 2px; }

        /* åº•éƒ¨æ“ä½œåŒº */
        .operation-area { height: 400px; background: var(--bg-dark); display: flex; flex-direction: column; }

        /* å…¨å±€å·¥å…·æ  (HEX, å‘é€é…ç½®) */
        .global-tools { padding: 8px 12px; background: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; font-size: 12px; flex-shrink: 0; flex-wrap: wrap; }
        .tool-group { display: flex; align-items: center; gap: 5px; }
        .t-checkbox { accent-color: var(--primary); }
        .t-select { background: #333; color: white; border: 1px solid #444; padding: 2px 5px; border-radius: 3px; }
        .t-btn { background: #333; border: 1px solid #444; color: #ccc; padding: 2px 8px; border-radius: 3px; cursor: pointer; }
        .t-btn:hover { background: #444; }

        /* å¿«æ·æŒ‡ä»¤ Tabs */
        .tabs { display: flex; background: #151515; border-bottom: 1px solid #333; }
        .tab { padding: 10px 20px; cursor: pointer; color: #888; font-size: 14px; border-bottom: 2px solid transparent; transition: 0.2s; }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); background: #222; }
        .tab-add { margin-left: auto; padding: 10px 15px; cursor: pointer; color: #888; }
        .tab-add:hover { color: white; background: #333; }

        /* æŒ‡ä»¤å®¹å™¨ */
        .cmd-container { flex: 1; overflow-y: auto; padding: 10px; }
        .cmd-group { margin-bottom: 12px; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
        .group-head { background: #252525; padding: 8px 12px; font-size: 12px; font-weight: bold; color: #ddd; display: flex; justify-content: space-between; cursor: pointer; }
        .group-body { padding: 10px; background: #1e1e1e; }
        
        /* å¸ƒå±€æ¨¡å¼: Grid (ç®€å•æŒ‡ä»¤) vs List (è¾“å…¥/æšä¸¾) */
        .layout-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .layout-list { display: flex; flex-direction: column; gap: 8px; }

        /* ç®€å•æŒ‡ä»¤æŒ‰é’® */
        .btn-simple { background: #333; color: #eee; border: 1px solid #444; padding: 10px; border-radius: 4px; text-align: center; font-size: 13px; cursor: pointer; user-select: none; }
        .btn-simple:active { background: var(--primary); border-color: var(--primary); }

        /* è¾“å…¥/æšä¸¾æŒ‡ä»¤è¡Œ */
        .cmd-row { display: flex; gap: 8px; align-items: center; background: #2a2a2a; padding: 5px; border-radius: 4px; border: 1px solid #333; }
        .cmd-label { width: 80px; font-size: 12px; color: #aaa; flex-shrink: 0; padding-left: 5px; }
        .cmd-input-ctrl { flex: 1; background: #121212; border: 1px solid #444; color: white; padding: 6px; border-radius: 3px; font-size: 13px; }
        .btn-send-small { background: #333; color: var(--primary); border: 1px solid #333; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .btn-send-small:active { background: #444; }

        /* --- ä¾§è¾¹æ  --- */
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 900; opacity: 0; pointer-events: none; transition: 0.3s; }
        .sidebar-overlay.open { opacity: 1; pointer-events: auto; }
        .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: var(--sidebar-width); background: var(--bg-sidebar); z-index: 901; transform: translateX(-100%); transition: transform 0.3s ease; box-shadow: 2px 0 10px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        .sidebar.open { transform: translateX(0); }
        .sb-header { padding: 20px; border-bottom: 1px solid #333; font-size: 18px; font-weight: bold; }
        .sb-list { flex: 1; overflow-y: auto; }
        .sb-item { padding: 15px 20px; border-bottom: 1px solid #222; cursor: pointer; display: flex; justify-content: space-between; }
        .sb-item:hover { background: #222; }
        .sb-item.active { background: #2a2a2a; border-left: 4px solid var(--primary); }
        .sb-actions { padding: 15px; border-top: 1px solid #333; }
        .btn-block { display: block; width: 100%; padding: 10px; margin-bottom: 10px; background: #333; border: 1px solid #444; color: white; cursor: pointer; border-radius: 4px; }
        .btn-block.primary { background: var(--primary); border-color: var(--primary); }

        /* --- å³é”®/é•¿æŒ‰èœå• --- */
        .ctx-menu { position: fixed; bottom: 0; left: 0; right: 0; background: #252525; border-radius: 12px 12px 0 0; z-index: 2000; transform: translateY(100%); transition: 0.2s; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        .ctx-menu.open { transform: translateY(0); }
        .ctx-head { padding: 15px; text-align: center; color: #888; font-size: 12px; border-bottom: 1px solid #333; }
        .ctx-item { padding: 16px; text-align: center; font-size: 16px; border-bottom: 1px solid #333; cursor: pointer; }
        .ctx-item.danger { color: var(--danger); }
        .ctx-item.cancel { color: #aaa; border: none; margin-top: 5px; }

        /* --- å¼¹çª— Modal --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 3000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-box { background: var(--bg-panel); width: 90%; max-width: 450px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-head { padding: 15px; border-bottom: 1px solid #333; font-weight: bold; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; }
        .form-input { width: 100%; padding: 10px; background: #121212; border: 1px solid #444; color: white; border-radius: 4px; }
        .modal-foot { padding: 15px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 10px; }
        
        /* åŠ¨æ€å­—æ®µæ˜¾éš */
        .d-field { display: none; }
        .d-field.show { display: block; }
        
        /* æšä¸¾åˆ—è¡¨æ„å»ºæ ·å¼ */
        .enum-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .btn-icon { width: 30px; background: #333; border: 1px solid #444; color: var(--danger); cursor: pointer; }

    </style>
</head>
<body>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sb-header">BlueConsole</div>
        <div class="sb-list" id="profileList"></div>
        <div class="sb-actions">
            <button class="btn-block" onclick="createProfile()">+ æ–°å»ºé…ç½®</button>
            <button class="btn-block" onclick="importProfile()">â˜ï¸ å¯¼å…¥é…ç½® (JSON)</button>
        </div>
    </div>

    <div class="app-container" id="app">
        <div class="header">
            <div style="display:flex; align-items:center;">
                <div class="menu-btn" onclick="toggleSidebar()">â˜°</div>
                <div class="header-info">
                    <span class="profile-name" id="currentProfileName">Default</span>
                    <span class="profile-hint">ç‚¹å‡»èœå•åˆ‡æ¢</span>
                </div>
            </div>
            <div class="conn-status">â— Connected</div>
        </div>

        <div class="log-area" id="logArea">
            <div class="log-row"><span class="ts">[12:00:00]</span><span class="rx">System Ready...</span></div>
        </div>

        <div class="splitter" id="splitter"><div class="splitter-handle"></div></div>

        <div class="operation-area" id="opArea">
            
            <div class="global-tools">
                <div class="tool-group">
                    <input type="checkbox" id="globalHex" class="t-checkbox">
                    <label for="globalHex">HEXå‘é€</label>
                </div>
                <div class="tool-group">
                    <label>è¡Œå°¾:</label>
                    <select id="globalEnd" class="t-select">
                        <option value="">None</option>
                        <option value="\r\n" selected>\r\n</option>
                        <option value="\n">\n</option>
                        <option value="\r">\r</option>
                    </select>
                </div>
                <div class="tool-group" style="margin-left:auto">
                    <label>å¾ªç¯(ms):</label>
                    <input type="number" id="loopMs" value="1000" style="width:50px" class="t-select">
                    <button class="t-btn" id="loopBtn" onclick="toggleLoop()">å¼€å§‹</button>
                </div>
                <button class="t-btn" onclick="document.getElementById('logArea').innerHTML=''">æ¸…å±</button>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('simple')" id="tab-simple">ç®€å•æŒ‡ä»¤</div>
                <div class="tab" onclick="switchTab('input')" id="tab-input">è¾“å…¥æŒ‡ä»¤</div>
                <div class="tab" onclick="switchTab('enum')" id="tab-enum">æšä¸¾æŒ‡ä»¤</div>
                <div class="tab-add" onclick="openEditor(false)">+</div>
            </div>

            <div class="cmd-container" id="cmdContainer">
                </div>
        </div>
    </div>

    <div class="sidebar-overlay" id="ctxOverlay" onclick="hideCtx()"></div>
    <div class="ctx-menu" id="ctxMenu">
        <div class="ctx-head" id="ctxTitle">æ“ä½œæŒ‡ä»¤</div>
        <div class="ctx-item" onclick="handleEdit()">âœï¸ ç¼–è¾‘æŒ‡ä»¤</div>
        <div class="ctx-item danger" onclick="handleDelete()">ğŸ—‘ï¸ åˆ é™¤æŒ‡ä»¤</div>
        <div class="ctx-item cancel" onclick="hideCtx()">å–æ¶ˆ</div>
    </div>

    <div class="modal" id="editorModal">
        <div class="modal-box">
            <div class="modal-head" id="modalTitle">æ·»åŠ æŒ‡ä»¤</div>
            <div class="modal-body">
                
                <div class="form-group" id="typeSelectGroup">
                    <label class="form-label">æŒ‡ä»¤ç±»å‹</label>
                    <select class="form-input" id="editType" onchange="updateEditorFields()">
                        <option value="simple">ç®€å•æŒ‡ä»¤ (ç‚¹å‡»å‘é€)</option>
                        <option value="input">è¾“å…¥æŒ‡ä»¤ (å¡«ç©ºå‘é€)</option>
                        <option value="enum">æšä¸¾æŒ‡ä»¤ (ä¸‹æ‹‰é€‰æ‹©)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">æŒ‡ä»¤åç§°</label>
                    <input type="text" class="form-input" id="editName" placeholder="ä¾‹å¦‚ï¼šæ‰“å¼€ç”µæœº">
                </div>

                <div class="form-group">
                    <label class="form-label">æ‰€å±åˆ†ç»„</label>
                    <div style="position: relative;">
                        <select class="form-input" id="groupSelect" onchange="checkNewGroup(this)">
                            </select>
                        <input type="text" class="form-input" id="newGroupInput" placeholder="è¾“å…¥æ–°åˆ†ç»„åç§°" style="display:none; margin-top:5px; border-color:var(--primary)">
                    </div>
                </div>

                <div id="fields-simple" class="d-field">
                    <div class="form-group">
                        <label class="form-label">å‘é€å†…å®¹</label>
                        <textarea class="form-input" id="simpleContent" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="simpleHex"> æ­¤æŒ‡ä»¤å¼ºåˆ¶ä½¿ç”¨ HEX</label>
                    </div>
                </div>

                <div id="fields-input" class="d-field">
                    <div class="form-group">
                        <label class="form-label">å‰ç¼€ (Prefix)</label>
                        <input type="text" class="form-input" id="inputPrefix" placeholder="ä¾‹å¦‚: SET_VOLT=">
                    </div>
                    <div class="form-group">
                        <label class="form-label">åç¼€ (Suffix)</label>
                        <input type="text" class="form-input" id="inputSuffix" placeholder="ä¾‹å¦‚: mV">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æç¤ºå ä½ç¬¦</label>
                        <input type="text" class="form-input" id="inputPlaceholder" placeholder="ä¾‹å¦‚: 3300">
                    </div>
                </div>

                <div id="fields-enum" class="d-field">
                    <label class="form-label">æšä¸¾åˆ—è¡¨ (æ˜¾ç¤ºå | å‘é€å€¼)</label>
                    <div id="enumBuilder" style="max-height:150px; overflow-y:auto; margin-bottom:10px;"></div>
                    <button class="t-btn" style="width:100%" onclick="addEnumRow()">+ æ·»åŠ é€‰é¡¹</button>
                </div>

            </div>
            <div class="modal-foot">
                <button class="t-btn" onclick="closeEditor()">å–æ¶ˆ</button>
                <button class="btn-block primary" style="width:auto; margin:0;" onclick="saveCommand()">ä¿å­˜</button>
            </div>
        </div>
    </div>

<script>
    // --- 1. æ•°æ®ç»“æ„ä¸åˆå§‹åŒ– ---
    // ä¸ºäº†æ”¯æŒ Tabs åˆ†ç±»ï¼Œæˆ‘ä»¬å°†æ•°æ®æŒ‰ç±»å‹å­˜å‚¨åœ¨ Profile ä¸­
    let profiles = [
        {
            id: 'p1',
            name: 'æ¼”ç¤ºé…ç½® (Demo)',
            // æ•°æ®åˆ†ä¸ºä¸‰ç±»ï¼Œæ¯ç±»æ˜¯ä¸€ä¸ªåˆ†ç»„æ•°ç»„
            // ç»“æ„: [ { group: "ç»„å", items: [ {name, ...data} ] } ]
            simple: [
                { group: 'ç³»ç»Ÿæ§åˆ¶', items: [{name:'å¤ä½', content:'RST'}, {name:'æŸ¥è¯¢', content:'?'}] },
                { group: 'LEDæµ‹è¯•', items: [{name:'çº¢ç¯å¼€', content:'LED_R_ON'}, {name:'çº¢ç¯å…³', content:'LED_R_OFF'}] }
            ],
            input: [
                { group: 'å‚æ•°è®¾ç½®', items: [{name:'è®¾ç½®ç”µå‹', pre:'SET_V=', suf:'mV', hint:'3300'}] }
            ],
            enum: [
                { group: 'æ¨¡å¼é€‰æ‹©', items: [{name:'å·¥ä½œæ¨¡å¼', options:[{k:'ä½åŠŸè€—',v:'MODE_LOW'},{k:'é«˜æ€§èƒ½',v:'MODE_HIGH'}]}] }
            ]
        }
    ];

    let state = {
        currentProfileId: 'p1',
        currentTab: 'simple', // simple | input | enum
        editTarget: null // { type, groupIndex, itemIndex } ç”¨äºå®šä½æ­£åœ¨ç¼–è¾‘çš„æŒ‡ä»¤
    };

    // åˆå§‹åŒ–
    window.onload = () => {
        renderSidebar();
        renderMain();
    };

    // --- 2. æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ ---
    
    function getCurrentProfile() {
        return profiles.find(p => p.id === state.currentProfileId);
    }

    function renderMain() {
        const p = getCurrentProfile();
        document.getElementById('currentProfileName').innerText = p.name;
        
        // æ›´æ–° Tab æ ·å¼
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${state.currentTab}`).classList.add('active');

        // æ¸²æŸ“æŒ‡ä»¤åŒº
        const container = document.getElementById('cmdContainer');
        container.innerHTML = '';
        
        // è·å–å½“å‰ Tab å¯¹åº”çš„æ•°æ®åˆ—è¡¨
        const groups = p[state.currentTab] || [];

        if (groups.length === 0) {
            container.innerHTML = `<div style="text-align:center; color:#555; margin-top:30px">æš‚æ—  ${state.currentTab} æŒ‡ä»¤<br>ç‚¹å‡»å³ä¸Šè§’ + æ·»åŠ </div>`;
            return;
        }

        // éå†åˆ†ç»„æ¸²æŸ“
        groups.forEach((g, gIndex) => {
            const groupEl = document.createElement('div');
            groupEl.className = 'cmd-group';
            
            // æ¸²æŸ“ Items
            let itemsHtml = '';
            if (state.currentTab === 'simple') {
                // ç½‘æ ¼å¸ƒå±€
                itemsHtml = `<div class="group-body layout-grid">` + 
                    g.items.map((item, i) => `
                        <div class="btn-simple" 
                             oncontextmenu="openCtx(event, '${state.currentTab}', ${gIndex}, ${i})"
                             onclick="sendSimple('${item.content}')">
                            ${item.name}
                        </div>
                    `).join('') + `</div>`;
            } else if (state.currentTab === 'input') {
                // åˆ—è¡¨å¸ƒå±€
                itemsHtml = `<div class="group-body layout-list">` + 
                    g.items.map((item, i) => `
                        <div class="cmd-row" oncontextmenu="openCtx(event, '${state.currentTab}', ${gIndex}, ${i})">
                            <div class="cmd-label">${item.name}</div>
                            <input type="text" class="cmd-input-ctrl" id="inp_${gIndex}_${i}" placeholder="${item.hint||''}">
                            <button class="btn-send-small" onclick="sendInput('${item.pre}', '${item.suffix||''}', 'inp_${gIndex}_${i}')">TX</button>
                        </div>
                    `).join('') + `</div>`;
            } else {
                // æšä¸¾åˆ—è¡¨å¸ƒå±€
                itemsHtml = `<div class="group-body layout-list">` + 
                    g.items.map((item, i) => {
                        const opts = item.options.map(o => `<option value="${o.v}">${o.k}</option>`).join('');
                        return `
                        <div class="cmd-row" oncontextmenu="openCtx(event, '${state.currentTab}', ${gIndex}, ${i})">
                            <div class="cmd-label">${item.name}</div>
                            <select class="cmd-input-ctrl" id="enum_${gIndex}_${i}">${opts}</select>
                            <button class="btn-send-small" onclick="sendEnum('enum_${gIndex}_${i}')">TX</button>
                        </div>
                    `}).join('') + `</div>`;
            }

            groupEl.innerHTML = `
                <div class="group-head" onclick="toggleGroup(this)">
                    <span>${g.group}</span> <span style="font-size:10px">â–¼</span>
                </div>
                ${itemsHtml}
            `;
            container.appendChild(groupEl);
        });
    }

    function switchTab(t) {
        state.currentTab = t;
        renderMain();
    }

    function toggleGroup(head) {
        const body = head.nextElementSibling;
        if (body.style.display === 'none') {
            body.style.display = (state.currentTab === 'simple') ? 'grid' : 'flex';
        } else {
            body.style.display = 'none';
        }
    }

    // --- 3. å‘é€é€»è¾‘ (æ¨¡æ‹Ÿ) ---

    function appendLog(type, msg) {
        const div = document.createElement('div');
        div.className = 'log-row';
        const time = new Date().toLocaleTimeString('en-GB');
        div.innerHTML = `<span class="ts">[${time}]</span><span class="${type}">${type.toUpperCase()}: ${msg}</span>`;
        const area = document.getElementById('logArea');
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    function processSend(raw) {
        // 1. è·å–å…¨å±€é…ç½®
        const isHex = document.getElementById('globalHex').checked;
        const endChar = document.getElementById('globalEnd').value.replace('\\r', '\r').replace('\\n', '\n');
        
        let finalStr = raw + endChar;
        // å¦‚æœæ˜¯ HEX æ¨¡å¼ï¼Œè¿™é‡Œåº”åšè½¬æ¢é€»è¾‘ï¼Œè¿™é‡Œç®€åŒ–ä¸ºæ‰“å°
        const displayStr = isHex ? `[HEX] ${raw}` : finalStr.replace(/\r/g,'\\r').replace(/\n/g,'\\n');
        
        appendLog('tx', displayStr);
        
        // æ¨¡æ‹Ÿå›åŒ…
        setTimeout(() => appendLog('rx', 'OK'), 200);
    }

    function sendSimple(content) { processSend(content); }
    function sendInput(pre, suf, inputId) {
        const val = document.getElementById(inputId).value;
        if(!val) return;
        processSend((pre||'') + val + (suf||''));
    }
    function sendEnum(selectId) {
        const val = document.getElementById(selectId).value;
        processSend(val);
    }

    // --- 4. ä¾§è¾¹æ  & é…ç½®æ–‡ä»¶é€»è¾‘ ---

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.querySelector('.sidebar-overlay').classList.toggle('open');
    }

    function renderSidebar() {
        const list = document.getElementById('profileList');
        list.innerHTML = profiles.map(p => `
            <div class="sb-item ${p.id === state.currentProfileId ? 'active' : ''}" onclick="switchProfile('${p.id}')">
                <div>${p.name}</div>
                ${profiles.length > 1 ? `<div style="color:#666; font-size:12px" onclick="event.stopPropagation(); deleteProfile('${p.id}')">âœ•</div>` : ''}
            </div>
        `).join('');
    }

    function switchProfile(id) {
        state.currentProfileId = id;
        renderSidebar();
        renderMain();
        toggleSidebar();
    }

    function createProfile() {
        const name = prompt("è¾“å…¥æ–°é…ç½®åç§°:");
        if (name) {
            profiles.push({ id: 'p'+Date.now(), name: name, simple:[], input:[], enum:[] });
            renderSidebar();
        }
    }
    
    function deleteProfile(id) {
        if(confirm('åˆ é™¤æ­¤é…ç½®ï¼Ÿ')) {
            profiles = profiles.filter(p => p.id !== id);
            if(state.currentProfileId === id) state.currentProfileId = profiles[0].id;
            renderSidebar();
        }
    }

    // --- 5. ç¼–è¾‘å™¨ & ä¸Šä¸‹æ–‡èœå•é€»è¾‘ ---

    // å³é”®èœå•
    function openCtx(e, type, gIdx, iIdx) {
        e.preventDefault();
        state.editTarget = { type, gIdx, iIdx };
        const menu = document.getElementById('ctxMenu');
        document.getElementById('ctxOverlay').classList.add('open');
        menu.classList.add('open');
    }
    function hideCtx() {
        document.getElementById('ctxOverlay').classList.remove('open');
        document.getElementById('ctxMenu').classList.remove('open');
    }

    function handleDelete() {
        if(!confirm('ç¡®å®šåˆ é™¤?')) return;
        const p = getCurrentProfile();
        const { type, gIdx, iIdx } = state.editTarget;
        
        // åˆ é™¤é¡¹
        p[type][gIdx].items.splice(iIdx, 1);
        // å¦‚æœç»„ç©ºäº†ï¼Œåˆ ç»„
        if(p[type][gIdx].items.length === 0) p[type].splice(gIdx, 1);
        
        hideCtx();
        renderMain();
    }

    function handleEdit() {
        hideCtx();
        openEditor(true);
    }

    // æ‰“å¼€ç¼–è¾‘å™¨ (isEdit: boolean)
    function openEditor(isEdit) {
        const modal = document.getElementById('editorModal');
        const p = getCurrentProfile();
        
        // é‡ç½®/å¡«å……è¡¨å•
        document.getElementById('newGroupInput').style.display = 'none';
        document.getElementById('groupSelect').style.display = 'block';
        
        if (isEdit && state.editTarget) {
            // === ç¼–è¾‘æ¨¡å¼ ===
            document.getElementById('modalTitle').innerText = "ç¼–è¾‘æŒ‡ä»¤";
            const { type, gIdx, iIdx } = state.editTarget;
            const item = p[type][gIdx].items[iIdx];
            const groupName = p[type][gIdx].group;

            // é”å®šç±»å‹é€‰æ‹©
            const typeSel = document.getElementById('editType');
            typeSel.value = type;
            typeSel.disabled = true;
            
            // å¡«å……åå­—
            document.getElementById('editName').value = item.name;

            // å¡«å……å­—æ®µ
            if(type === 'simple') document.getElementById('simpleContent').value = item.content;
            if(type === 'input') {
                document.getElementById('inputPrefix').value = item.pre || '';
                document.getElementById('inputSuffix').value = item.suf || '';
                document.getElementById('inputPlaceholder').value = item.hint || '';
            }
            if(type === 'enum') {
                document.getElementById('enumBuilder').innerHTML = '';
                item.options.forEach(o => addEnumRow(o.k, o.v));
            }

            // å¡«å……å¹¶é€‰ä¸­åˆ†ç»„
            fillGroupSelect(type, groupName);
            
            modal.dataset.mode = 'edit';
        } else {
            // === æ–°å»ºæ¨¡å¼ ===
            document.getElementById('modalTitle').innerText = "æ·»åŠ æŒ‡ä»¤";
            document.getElementById('editType').disabled = false;
            document.getElementById('editType').value = state.currentTab; // é»˜è®¤é€‰ä¸­å½“å‰tab
            
            document.getElementById('editName').value = '';
            document.getElementById('simpleContent').value = '';
            document.getElementById('inputPrefix').value = '';
            document.getElementById('enumBuilder').innerHTML = '';
            addEnumRow(); // é»˜è®¤åŠ ä¸€è¡Œ

            fillGroupSelect(state.currentTab, '');
            modal.dataset.mode = 'add';
        }

        updateEditorFields(); // åˆ·æ–°å­—æ®µæ˜¾ç¤º
        modal.classList.add('show');
    }

    function closeEditor() {
        document.getElementById('editorModal').classList.remove('show');
    }

    // åŠ¨æ€æ˜¾éšå­—æ®µ
    function updateEditorFields() {
        const type = document.getElementById('editType').value;
        document.querySelectorAll('.d-field').forEach(el => el.classList.remove('show'));
        document.getElementById(`fields-${type}`).classList.add('show');
        
        // å¦‚æœæ˜¯æ–°å»ºæ¨¡å¼ï¼Œåˆ‡ç±»å‹æ—¶è¦åˆ·æ–°åˆ†ç»„åˆ—è¡¨ï¼ˆå› ä¸ºä¸åŒç±»å‹çš„åˆ†ç»„æ˜¯åˆ†å¼€å­˜çš„ï¼‰
        if (document.getElementById('editorModal').dataset.mode === 'add') {
             fillGroupSelect(type, '');
        }
    }

    // åˆ†ç»„ä¸‹æ‹‰æ¡†é€»è¾‘
    function fillGroupSelect(type, selectedVal) {
        const p = getCurrentProfile();
        const select = document.getElementById('groupSelect');
        select.innerHTML = `<option value="">-- é€‰æ‹©åˆ†ç»„ --</option>`;
        
        // ç°æœ‰åˆ†ç»„
        const groups = p[type] || [];
        groups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.group;
            opt.innerText = g.group;
            if(g.group === selectedVal) opt.selected = true;
            select.appendChild(opt);
        });
        
        // æ–°å»ºé€‰é¡¹
        const newOpt = document.createElement('option');
        newOpt.value = '__NEW__';
        newOpt.innerText = '+ æ–°å»ºåˆ†ç»„...';
        newOpt.style.color = '#2196F3';
        select.appendChild(newOpt);
    }

    function checkNewGroup(sel) {
        if(sel.value === '__NEW__') {
            sel.style.display = 'none';
            const inp = document.getElementById('newGroupInput');
            inp.style.display = 'block';
            inp.focus();
        }
    }

    // æšä¸¾æ„å»ºå™¨é€»è¾‘
    function addEnumRow(k='', v='') {
        const div = document.createElement('div');
        div.className = 'enum-row';
        div.innerHTML = `
            <input type="text" class="form-input" placeholder="æ˜¾ç¤ºå" value="${k}" style="flex:1">
            <input type="text" class="form-input" placeholder="å‘é€å€¼" value="${v}" style="flex:1">
            <button class="btn-icon" onclick="this.parentElement.remove()">Ã—</button>
        `;
        document.getElementById('enumBuilder').appendChild(div);
    }

    // ä¿å­˜é€»è¾‘
    function saveCommand() {
        const mode = document.getElementById('editorModal').dataset.mode;
        const type = document.getElementById('editType').value;
        const name = document.getElementById('editName').value;
        
        // è·å–åˆ†ç»„å
        let groupName = document.getElementById('groupSelect').value;
        if (groupName === '__NEW__') groupName = document.getElementById('newGroupInput').value;
        if (!name || !groupName) { alert('è¯·å¡«å†™åç§°å’Œåˆ†ç»„'); return; }

        // æ„é€ æ•°æ®å¯¹è±¡
        let newItem = { name: name };
        if (type === 'simple') {
            newItem.content = document.getElementById('simpleContent').value;
        } else if (type === 'input') {
            newItem.pre = document.getElementById('inputPrefix').value;
            newItem.suf = document.getElementById('inputSuffix').value;
            newItem.hint = document.getElementById('inputPlaceholder').value;
        } else if (type === 'enum') {
            newItem.options = [];
            document.querySelectorAll('#enumBuilder .enum-row').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if(inputs[0].value) newItem.options.push({ k: inputs[0].value, v: inputs[1].value });
            });
        }

        const p = getCurrentProfile();

        if (mode === 'edit') {
            // --- æ›´æ–° ---
            const { gIdx, iIdx } = state.editTarget;
            const oldGroup = p[type][gIdx];
            
            // å¦‚æœåˆ†ç»„æ²¡å˜
            if (oldGroup.group === groupName) {
                oldGroup.items[iIdx] = newItem;
            } else {
                // åˆ†ç»„å˜äº†ï¼šç§»å‡ºæ—§ç»„ -> åŠ å…¥æ–°ç»„
                oldGroup.items.splice(iIdx, 1);
                if(oldGroup.items.length===0) p[type].splice(gIdx, 1);
                addToGroup(p, type, groupName, newItem);
            }
        } else {
            // --- æ–°å¢ ---
            addToGroup(p, type, groupName, newItem);
        }

        closeEditor();
        renderMain();
    }

    function addToGroup(profile, type, gName, item) {
        let targetGroup = profile[type].find(g => g.group === gName);
        if (!targetGroup) {
            targetGroup = { group: gName, items: [] };
            profile[type].push(targetGroup);
        }
        targetGroup.items.push(item);
    }

    // --- 6. æ‹–åŠ¨ Splitter ---
    const splitter = document.getElementById('splitter');
    const app = document.getElementById('app');
    let isDragging = false;
    splitter.addEventListener('mousedown', () => isDragging = true);
    document.addEventListener('mouseup', () => isDragging = false);
    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const h = e.clientY - 50; // å‡å» header é«˜åº¦
        if (h > 100 && h < app.clientHeight - 100) {
            document.getElementById('logArea').style.flex = 'none';
            document.getElementById('logArea').style.height = h + 'px';
        }
    });

    // --- 7. å¾ªç¯å‘é€é€»è¾‘ ---
    let loopTimer = null;
    function toggleLoop() {
        const btn = document.getElementById('loopBtn');
        if (loopTimer) {
            clearInterval(loopTimer);
            loopTimer = null;
            btn.innerText = "å¼€å§‹";
            btn.style.color = "#ccc";
        } else {
            const ms = parseInt(document.getElementById('loopMs').value) || 1000;
            // è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œå‡è®¾å¾ªç¯å‘é€ä¸€æ¡å›ºå®šæŒ‡ä»¤ï¼Œå®é™…å¯å…³è”è‡ªå®šä¹‰å‘é€åŒº
            loopTimer = setInterval(() => {
                processSend("LOOP_DATA");
            }, ms);
            btn.innerText = "åœæ­¢";
            btn.style.color = "#00E676";
        }
    }

</script>
</body>
</html>